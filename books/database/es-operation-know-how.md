# 기초부터 다지는 ES 운영 노하우

- [책 링크](https://www.yes24.com/Product/Goods/96520155)

## 1. ES 흝어보기

- ES는 루씬 기반의 오픈 소스 검색 엔진이다. JSON 기반의 문서를 저장하고 검색할 수 있다.
- ES의 몇 가지 특징은 아래와 같다.
  - ES는 준실시간성 검색 엔진으로 볼 수 있다. 문서를 입력하자마자 검색하는 것은 불가능하더라도 1초의 시간이 흐른뒤에는 검색이 가능하기 때문이다.
  - 클러스터로 구성하여 안정성을 높이고 부하를 분산시킬 수 있다.
  - 스키마리스로 필드를 사전에 정의하지 않아도 된다.
  - REST API 기반의 인터페이스를 지원하여 진입 장벽이 낮은 편이다.

## 2. ES 기본동작

- 인덱스의 생성, 문서 색인/수정 등의 과정을 확인하자.

  ```Elixir
    # 인덱스 생성
    PUT /contents

    # 생성된 인덱스 조회
    GET _cat/indices?v

    # 문서 추가
    PUT /contents/_doc/1
    {
      "title": "제목~",
      "author": "seo.jeong.kuk"
    }

    # 문서 조회
    GET /contents/_mappings?pretty
  ```

## 3. ES 모니터링

- 오픈 소스인 Head, 프로메테우스, X-Pack을 이용해서 모니터링 방법과 장단점을 살펴본다.
- 2021년에 나온 내용이라 그런지 책의 내용과 로컬에 설치된 ES 8 버전과 kibana 화면이 달라 정리하지 않는다.

## 4. ES 기본개념

### 4.1 클러스터와 노드의 개념

- 클러스터란 여러 컴퓨터를 논리적으로 결합하여 전체를 하나의 컴퓨터 혹은 구성 요소로 사용할 수 있도록 하는 기술이다. 이때 클러스터를 구성하는 하나 하나의 ES 프로세스를 노드라고 부른다. 여러 개의 ES 노드를 ES처럼 동작하는 것이 ES 클러스터라고 할 수 있다. 다수의 노드로 클러스터를 구성하면 하나의 노드에 장애가 발생해도 안정적으로 클러스터를 유지할 수 있다.
- `curl localhost:9200` 명령어를 통해 ES의 버전이나 클러스터의 정보를 확인할 수 있다.
- 마스터 노드는 클러스터의 메타데이터를 관리하며 반드시 한 대 이상으로 구성해야 한다. 클러스터의 모든 노드는 현재 노드의 상태, 성능 정보, 샤드의 정보를 마스터 노드에게 알린다.
- 데이터 노드는 사용자가 색인한 문서를 저장하고 검색 요청을 처리해 결과를 돌려주는 역할을 한다. 받은 요청 중 자신이 처리할 수 있는 요청을 직접 처리하고 다른 데이터 노드가 처리할 요청은 해당 데이터 노드에게 전달한다.

### 4.2 인덱스와 타입

- ES 6.x 이후의 버전은 하나의 인덱스에 하나의 타입만을 사용하도록 변경되었지만 ES 5.x 까지는 하나의 인덱스에 여러개의 타입을 사용할 수 있었다.

  ```Elixir
    PUT /test_index/test_type1
    PUT /test_index/test_type2
  ```

- ES 6.x 버전부터 멀티 타입을 허용하지 않는 이유는 인덱스의 여러 타입의 키가 동일한 경우 검색 결과에서 의도치 않은 결과가 나타났기 때문이다.

  ```Elixir
    PUT /test_index/test_type1
    {
      "name": "타입1_이름"
    }

    PUT /test_index/test_type2
    {
      "name": "타입2_이름"
    }

    # test_index에 검색 시 의도하지 않게 둘 다 검색될 수 있음
  ```
