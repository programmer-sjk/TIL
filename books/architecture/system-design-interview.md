# 가상 면접 사례로 배우는 대규모 시스템 설계 기초

- [책 링크](https://product.kyobobook.co.kr/detail/S000001033116)

## 사용자 수에 따른 규모 확장성

- 천리길도 한 걸음부터라는 말이 있듯, 서버가 한 대인 간단한 시스템부터 설계해보자.
- 클라이언트는 웹과 앱이고 서버 한대와 DB 한 대가 있다.

  <img src="https://github.com/programmer-sjk/TIL/blob/main/images/architecture/system-design-interview/simple.png" width="500">

### 어떤 데이터베이스를 사용할 것인가?

- 전통적인 관계형 DB와 비관계형 DB 사이에서 고를 수 있다. 차이점을 알아보자.
- RDBMS는 데이터를 테이블과 열, 커럼으로 표현한다. SQL을 사용해 테이블을 관계에 따라 조인하여 합칠 수 있다.
- 비 관계형 DB는 NoSQL이라고 부른다. 키-값 저장소, 그래프 저장소, 컬럼 저장소, 문서 저장소가 대표적이다.
- 대부분 RDBMS가 최선일텐데 그 이유는 40년 이상 시장에서 살아남아 작동해온 시스템이기 때문이다.
- 그 외에도 아래 같은 경우 비 관계형 DB가 바람직한 선택일 수 있다.
  - 아주 낮은 지연시간이 요구됨
  - 다루는 데이터가 비정형이나 관계형 데이터가 아님 (schema가 고정되어 있지 않음)
  - 아주 많은 양의 데이터를 저장하고 조회할 필요가 있음

### 수직적 규모 확장 VS 수평적 규모 확장

- 수직적 규모 확장은 scale up 이며 서버에 고사양 자원(cpu, memory)를 확장하는 행위를 말한다.
- 수평적 규모 확장은 scale out 이며 더 많은 서버를 추가하여 성능을 개선하는 행위를 말한다.
- 서버로 유입되는 트래픽이 적을 때는 수직적 확장도 선택 방법이며 장점은 단순함이다. 하지만 수직적 확장은 자원을 무한대로 증설할 수 없는 한계가 있으며 장애에 대한 자동복구나 다중화 방안을 지원하지 않는다.
- 이런 이유로 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장이 보다 적절하다.
- 앞에 간단한 시스템 설계에서는 사용자가 웹 서버에 바로 연결된다. 너무 많은 사용자가 접속하면 부하가 심하기 때문에 로드밸런서를 도입해야 한다.

### 로드밸런서

- 로드밸런서는 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.
- 사용자는 로드밸런서의 공개 IP주소로 접속한다. 따라서 웹 서버가 클라이언트의 접속을 직접 처리하지 않는다.
- 보안을 위해 로드밸런서와 뒷단의 서버 간 통신에는 사설 IP를 사용한다. 같은 네트워크에 속해야만 통신이 가능하기 때문에 외부 인터넷에서는 뒷단의 서버에 직접 접속할 수 없다.
- 로드 밸런서에 두 개 이상의 서버가 연결되면 장애를 자동복구하지 못하는 문제가 해소되며, 웹 계층의 가용성이 향상된다.

### DB 다중화

- 일반적으로 Master DB에 쓰기 연산을 수행하고 Slave DB에 읽기 연산을 수행하도록 다중화한다.
- DB를 다중화 해두면 아래와 같은 이점들이 존재한다.
  - 쓰기 연산과 읽기 연산이 분산되므로 병렬로 처리할 수 있는 쿼리 수가 늘어나므로 성능이 좋아진다.
  - 하나의 DB에 장애가 발생하더라도 다른 DB의 데이터를 가져와 계속 서비스를 할 수 있게 된다.
- DB를 Master, Slave 한 대씩 다중화한 상황에서 DB 하나가 다운되면 무슨 상황이 벌어지게 될까?
  - Slave가 다운된 상황이라면 읽기연산은 한시적으로 Master가 수행하게 된다. 새로운 Slave가 곧 추가되어 기존의 장애 서버를 대체한다.
  - Master가 다운된 상황이라면 Slave가 Master로 승격되어 쓰기 연산을 처리하게 된다. 이때 Slave의 데이터가 최신 데이터가 아닐 수 있는데 없는 데이터는 복구 스크립트를 돌려서 추가해야 한다.

### 캐시

- 캐시는 자주 사용되는 데이터를 메모리에 두고, 디스크에 접근하지 않고 빠른 응답을 제공하기 위해 사용된다.
- 캐시는 DB보다 훨씬 빠르다. 캐시를 두면 성능이 개선될 뿐 아니라 DB 부하를 줄일 수 있다.
- 캐시를 사용할 때는 아래 사항들을 고려해야만 한다.
  - 캐시는 어떤 데이터에 바람직한가: 자주 조회되지만 자주 갱신되는 않는 데이터
  - 어떤 데이터를 캐시에 둬야 할까: 캐시는 데이터를 휘발성 메모리에 두기에 영속적으로 보관할 데이터를 캐시에 두면 안된다.
  - 캐시 데이터의 만료 기간: 만료 시간이 너무 짧으면 DB를 자주 호출하기 때문에 적절한 만료 기한을 설정해야 한다.
  - 캐시의 일관성: 여기서 일관성은 DB와 캐시 데이터가 같은지 여부이다. 시스템이 크질때 캐시와 저장소 사이에 일관성을 유지하는것은 어려운 문제이다.
  - SPOF: 캐시 서버를 한대만 두면 단일 장애 지점이 될 수 있다. 결과적으로 SPOF를 피하려면 캐시 서버를 분산시켜야 한다.
  - 캐시 메모리: 메모리가 너무 작으면 데이터가 자주 밀려나버려 성능이 떨어진다. 이를 위해 조금 과하게 메모리를 할당하는 방법이 있다.
  - 데이터 방출 정책: 캐시가 꽉 차면 기존 데이터를 보내야 한다. LRU(Recently Used), LFU(Frequently Used, 사용빈도) 등 정책을 적용해야 한다.

### 컨텐츠 전송 네트워크 CDN

- CDN은 정적 컨텐츠를 전송하는 네트워크이다. 이미지, 비디오, CSS, JS 파일 등을 캐시할 수 있다.
- 사용자가 웹 사이트에 방문하면 사용자에게 가장 가까운 CDN 서버가 정적 컨텐츠르 전달하게 된다.
- CDN 동작에 대해 설명한다.
  - 사용자는 이미지 URL을 이용해 CDN이 제공하는 이미지에 접근한다.
  - CDN 캐시에 이미지가 없는 경우, CDN 서버는 원본 서버(웹 서버, S3)에 요청해 파일을 가져온다.
  - 원본 서버가 파일을 CDN 서버에 반환하며 HTTP 헤더에 TTL 값이 들어있다. CDN 서버는 파일을 캐시하고 사용자에게 반환한다.
  - 다른 사용자의 접속이 들어오면 만료되지 않은 캐시된 파일의 경우 CDN 서버가 제공한다.

<img src="https://github.com/programmer-sjk/TIL/blob/main/images/architecture/system-design-interview/cdn.png" width="500">

- CDN 사용시 고려할 점
  - CDN은 비용이 나가므로 자주 사용되지 않는 컨텐츠는 캐싱에서 빼는것이 좋다.
  - 만료 기한이 너무 짧지도 길지도 않은 적절한 시간을 잘 설정해야 한다.
  - CDN 자체가 죽었을 때 웹 서버가 어떻게 동작할지 고려해야 한다. 가령 CDN이 응답이 없을 경우, 클라이언트가 원본 서버에게 요청하도록 구성할 수 있다.

### 무상태 웹 계층

-
