# 가상 면접 사례로 배우는 대규모 시스템 설계 기초 2

- [책 링크](https://product.kyobobook.co.kr/detail/S000211656186)

## 근접성 서비스

- 근접성 서비스는 현재 위치에서 가까운 시설을 찾는데 이용된다.

### 문제 이해 및 설계 범위 확정

```text
지원자: 사용자가 검색 반경을 지정할 수 있어야 하나요? 검색 반경내에 사업장이 충분치 않으면 시스템이 알아서 넓혀도 될까요?
면접관: 일단은 주어진 반경 내의 사업장을 대상으로 한다고 하시죠.

지원자: 최대 허용 반경은 얼마입니까? 20km로 가정해도 괜찮을까요?
면접관: 네 좋습니다.

지원자: 사용자가 UI에서 검색 반경을 변경할 수 있어야 하나요?
면접관: 네. 0.5km, 1km, 2km, 5km, 20km 내에서 선택할 수 있어야 합니다.

지원자: 사업장 정보는 어떻게 시스템에 추가되고, 삭제되고, 갱신됩니까? 사업장 정보가 사용자에게 실시간으로 보여져야 할까요?
면접관: 사업장 소유주가 사업장 정보를 시스템에 추가,삭제,갱신할 수 있어야 합니다. 추가되거나 갱신된 정보는 다음날까지 반영된다고 가정합시다.
```

- 위 대화에 근거하여 다음 세가지 기능에 집중하자.
  - 사용자의 위치와 검색 반경 정보에 매칭되는 사업장 목록을 반환
  - 사업장 소유주가 사업장 정보를 추가,삭제,갱신할 수 있도록 하되 그 정보가 실시간으로 반영될 필요는 없다고 가정
  - 고객은 사업장의 상세 정보를 살필 수 있어야 함

### 개략적 설계안 제시 및 동의 구하기

- RESTFUL API 관례를 따르는 간단한 API를 만들어 보도록 하겠다.
  - GET /v1/search/nearby
- 이 API는 특정 검색 기준에 맞는 사업장 목록을 반환한다. 실제로 사용되는 어플리케이션의 경우 페이지 단위로 반환하겠지만 여기서는 신경쓰지 않겠다. API 호출 시에 전달할 인자는 다음과 같다.
  - latitude (위도), longitude (경도), radius (선택적 인자로 기본값은 5000m)
- 반환되는 결과는 다음과 같은 형태를 띤다.
  - `{ total: 10, businesses: [{ business object }]}`
  - business object는 각 사업장을 표현하는 객체로 페이지에 표시될 모든 정보를 포함한다.
- 아래는 사업장 객체 관련 API이다.
  - `GET /v1/businesses/:id` 특정 사업자의 상세 정보 반환
  - `POST /v1/businesses/:id` 새로운 사업자 추가
  - `PUT /v1/businesses/:id` 사업장 상세 정보 갱신
  - `DELETE /v1/businesses/:id` 특정 사업장 정보 삭제

#### 데이터 모델

- 주변 사업장 검색, 사업장 정보 확인. 이 두 가지 용도로 읽기 연산은 굉장히 자주 수행된다.
- 한편 쓰기 연산 빈도는 낮은데, 사업장 정보를 추가하거나 삭제, 편집하는 행위는 빈번하지 않기 때문이다.
- 읽기 연산이 압도적인 시스템에서는 MySQL 같은 관계형 데이터베이스가 바람직할 수 있다.
- 시스템의 핵심이 되는 테이블은 business와 지리적 위치 색인 테이블이다.

  - 지리적 위치 색인 테이블은 위치 정보 연산의 효율성을 높이는데 쓰인다. 지오해시(geohash) 지식이 필요하므로 뒤에서 논의한다.

  <img src="https://github.com/programmer-sjk/TIL/blob/main/images/books/architecture/system-design2/proximity.png" width="500">

- 위 그림에서 LBS는 위치 기반 서비스이다. 주어진 위치와 반경 정보를 가지고 주변 사업장을 검색한다.
  - 쓰기 요청이 적고 읽기 요청이 빈번하게 발생하는 서비스이다.
  - QPS가 높다. 특히 특정 시간대의 인구 밀집 지역일수록 그 경향이 심하다.
  - 무상태 서비스이므로 수평적 규모 확장이 쉽다.

#### 주변 사업장 검색 알고리즘

- 실제로 많은 회사가 Redis의 지오해시나 PostGIS 확장을 설치한 Postgres 데이터베이스를 활용한다.
- 지리적 정보 색인을 만드는 방법에는 여러 알고리즘이 있지만 지오해시나 쿼드트리가 많이 쓰이고 있다.
- 이 둘을 가볍게 비교해보자.
  - 지오해시
    - 구현과 사용이 쉽고 트리를 새로 구축할 필요가 없다.
    - 지정 반경 이내 사업장 검색을 지원한다.
    - 인구 밀도에 따라 동적으로 격자 크기를 조정할 수는 없다.
    - 색인 갱신이 쉽다. 색인에서 사업장 하나를 삭제하려면 지오해시 값과 사업장 식별자가 같은 열 하나를 제거하기만 하면 된다.
  - 쿼드 트리
    - 트리를 구축해야 해서 구현하기가 살짝 더 까다롭다.
    - 가장 근거리의 k개의 무언가를 찾기 쉽다.
    - 인구 밀도에 따라 동적으로 격자 크기를 조정할 수 있다.
    - 지오해시보다 색인 갱신은 까다롭다.
