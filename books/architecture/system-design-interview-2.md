# 가상 면접 사례로 배우는 대규모 시스템 설계 기초 2

- [책 링크](https://product.kyobobook.co.kr/detail/S000211656186)

## 근접성 서비스

- 근접성 서비스는 현재 위치에서 가까운 시설을 찾는데 이용된다.

### 문제 이해 및 설계 범위 확정

```text
지원자: 사용자가 검색 반경을 지정할 수 있어야 하나요? 검색 반경내에 사업장이 충분치 않으면 시스템이 알아서 넓혀도 될까요?
면접관: 일단은 주어진 반경 내의 사업장을 대상으로 한다고 하시죠.

지원자: 최대 허용 반경은 얼마입니까? 20km로 가정해도 괜찮을까요?
면접관: 네 좋습니다.

지원자: 사용자가 UI에서 검색 반경을 변경할 수 있어야 하나요?
면접관: 네. 0.5km, 1km, 2km, 5km, 20km 내에서 선택할 수 있어야 합니다.

지원자: 사업장 정보는 어떻게 시스템에 추가되고, 삭제되고, 갱신됩니까? 사업장 정보가 사용자에게 실시간으로 보여져야 할까요?
면접관: 사업장 소유주가 사업장 정보를 시스템에 추가,삭제,갱신할 수 있어야 합니다. 추가되거나 갱신된 정보는 다음날까지 반영된다고 가정합시다.
```

- 위 대화에 근거하여 다음 세가지 기능에 집중하자.
  - 사용자의 위치와 검색 반경 정보에 매칭되는 사업장 목록을 반환
  - 사업장 소유주가 사업장 정보를 추가,삭제,갱신할 수 있도록 하되 그 정보가 실시간으로 반영될 필요는 없다고 가정
  - 고객은 사업장의 상세 정보를 살필 수 있어야 함

### 개략적 설계안 제시 및 동의 구하기

- RESTFUL API 관례를 따르는 간단한 API를 만들어 보도록 하겠다.
  - GET /v1/search/nearby
- 이 API는 특정 검색 기준에 맞는 사업장 목록을 반환한다. 실제로 사용되는 어플리케이션의 경우 페이지 단위로 반환하겠지만 여기서는 신경쓰지 않겠다. API 호출 시에 전달할 인자는 다음과 같다.
  - latitude (위도), longitude (경도), radius (선택적 인자로 기본값은 5000m)
- 반환되는 결과는 다음과 같은 형태를 띤다.
  - `{ total: 10, businesses: [{ business object }]}`
  - business object는 각 사업장을 표현하는 객체로 페이지에 표시될 모든 정보를 포함한다.
- 아래는 사업장 객체 관련 API이다.
  - `GET /v1/businesses/:id` 특정 사업자의 상세 정보 반환
  - `POST /v1/businesses/:id` 새로운 사업자 추가
  - `PUT /v1/businesses/:id` 사업장 상세 정보 갱신
  - `DELETE /v1/businesses/:id` 특정 사업장 정보 삭제

#### 데이터 모델

- 주변 사업장 검색, 사업장 정보 확인. 이 두 가지 용도로 읽기 연산은 굉장히 자주 수행된다.
- 한편 쓰기 연산 빈도는 낮은데, 사업장 정보를 추가하거나 삭제, 편집하는 행위는 빈번하지 않기 때문이다.
- 읽기 연산이 압도적인 시스템에서는 MySQL 같은 관계형 데이터베이스가 바람직할 수 있다.
- 시스템의 핵심이 되는 테이블은 business와 지리적 위치 색인 테이블이다.

  - 지리적 위치 색인 테이블은 위치 정보 연산의 효율성을 높이는데 쓰인다. 지오해시(geohash) 지식이 필요하므로 뒤에서 논의한다.

  <img src="https://github.com/programmer-sjk/TIL/blob/main/images/books/architecture/system-design2/proximity.png" width="500">

- 위 그림에서 LBS는 위치 기반 서비스이다. 주어진 위치와 반경 정보를 가지고 주변 사업장을 검색한다.
  - 쓰기 요청이 적고 읽기 요청이 빈번하게 발생하는 서비스이다.
  - QPS가 높다. 특히 특정 시간대의 인구 밀집 지역일수록 그 경향이 심하다.
  - 무상태 서비스이므로 수평적 규모 확장이 쉽다.

#### 주변 사업장 검색 알고리즘

- 실제로 많은 회사가 Redis의 지오해시나 PostGIS 확장을 설치한 Postgres 데이터베이스를 활용한다.
- 지리적 정보 색인을 만드는 방법에는 여러 알고리즘이 있지만 지오해시나 쿼드트리가 많이 쓰이고 있다.
- 이 둘을 가볍게 비교해보자.
  - 지오해시
    - 구현과 사용이 쉽고 트리를 새로 구축할 필요가 없다.
    - 지정 반경 이내 사업장 검색을 지원한다.
    - 인구 밀도에 따라 동적으로 격자 크기를 조정할 수는 없다.
    - 색인 갱신이 쉽다. 색인에서 사업장 하나를 삭제하려면 지오해시 값과 사업장 식별자가 같은 열 하나를 제거하기만 하면 된다.
  - 쿼드 트리
    - 트리를 구축해야 해서 구현하기가 살짝 더 까다롭다.
    - 가장 근거리의 k개의 무언가를 찾기 쉽다.
    - 인구 밀도에 따라 동적으로 격자 크기를 조정할 수 있다.
    - 지오해시보다 색인 갱신은 까다롭다.

### 상세 설계

- 지오해시나 쿼드트리 둘 다 널리 사용되지만 본 설계에서는 좀 더 단순한 지오해시를 사용하도록 하겠다.
- 지오해시 테이블 구성 방법은 두 가지이다.
  - 각각의 지오해시에 연결되는 모든 사업장 ID를 JSON 배열로 만들어 같은 열에 저장하는 방안이다.
  - 지오해시에 해당하는 사업장 ID를 각각 별도의 열로 저장하는 방법이다. 따라서 같은 지오해시에 해당하는 여러 열이 존재한다.
- 위 방법 중 두번째 방법을 추천한다.
  - 방안 1의 경우, 사업자 정보를 갱신하려면 JSON 배열을 읽고 사업장 ID를 찾아내야 한다. 새 사업장을 등록해야 하는 경우에도 이미 데이터가 있는지 전부 살펴봐야 한다.

#### 지리 정보 색인의 규모 확장

- 지리 정보 색인의 규모를 확장할 때 성급하게 샤딩 방법을 결정하는 실수를 저지르곤 한다. 하지만 현재 보고 있는 설계안의 경우 필요한 전체 데이터 양은 많지 않다. 색인 전부를 최신 DB 서버 한 대에 수용할 수 있다. 하지만 읽기 연산의 빈도가 높다면 서버 한대의 CPU와 네트워크 대역폭으로는 감당하지 못할 수도 있다. 그런 상황에선 여러 DB 서버로 부하를 분산해야 한다.
- 관계형 DB의 부하분산에는 두 가지 방법이 있다. 하나는 읽기 연산을 지원할 사본 DB를 늘리는 방법이고 다른 하나는 샤딩을 적용하는 것이다. 지오해시 테이블은 샤딩이 까다로우므로 샤딩을 강제할 필요는 없다. 따라서 이번 설계에서는 읽기 부하를 나눌 방법으로 읽기 DB를 두는 방법을 택하겠다.

#### 캐시

- 캐시 도입 전에 이런 질문을 던져야 한다. 정말 필요한가? 정말 좋은 결과로 이어지리라는 결론을 내리기는 어려울 것이다.
- 대부분 읽기 중심이고 DB 데이터 크기가 작아서 모든 데이터는 한 대의 DB 서버에 수용가능하다. 이런 경우 DB 버퍼 풀에 의해 캐시되어 I/O 부하가 크게 좌우되지 않는다.
- 만약 캐시를 사용하기로 했다면 가장 직관적인 캐시 키는 사용자의 위도와 경도 정보다. 하지만 사용자가 이동하면 위도와 경도 정보가 미세하게 변한다. 위치가 조금 달라지더라도 변화가 없어야 이상적이다. 지오해시나 쿼드트리는 이 문제를 효과적으로 해결한다. 같은 격자 내 모든 사업장이 같은 해시 값을 갖도록 만들 수 있기 때문이다.
