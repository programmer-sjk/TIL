# 대규모 서비스를 지탱하는 기술

- [책 링크](https://product.kyobobook.co.kr/detail/S000001550638)

## 1. 대규모 웹 서비스 개발 오리엔테이션

### 대규모 서비스와 소규모 서비스

#### 소규모 서비스와 대규모 서비스의 차이

- 서버 몇 대 있는 소규모 서비스에는 없는, 대규모 서비스에만 있는 문제나 어려움에는 어떤 점들이 있을까?
  - 확장성 확보, 부하 분산 필요
    - 서버 1대일때는 필요 없던 로드 밸런서 도입이 필요
    - DB의 데이터 동기화는 어떻게 할 것인가?
  - 다중성 확보
    - 서버가 고장나거나 성능이 저하되더라도 서비스를 계속할 수 있는 구성이 필요하다.
  - 효율적 운용
    - 서버가 1대라면 정상 동작하는지 간단히 파악이 가능하다.
    - 서버 대수가 100대를 넘어서면 각 서버가 어떤 역할을 하는지 파악하는 것도 고생거리다.
    - 감시용 SW를 사용하고 정보관리를 위해 자동화를 하게 된다.
  - 개발자 수, 개발 방법
    - 개발 표준화를 어떻게 할 것인가? 언어를 통일하고 코딩 규약을 표준화, 코드 버전관리 등 팀 매니저먼트가 필요해진다.

#### 대규모 데이터량에 대한 대처

- 컴퓨터에서 데이터는 디스크 -> 메모리 -> 캐시 메모리 -> CPU와 같이 몇 단계를 경유해서 처리된다.
- 데이터량이 많아지면 처음부터 캐시 미스가 발생하게 되고 저속의 디스크 I/O가 많이 발생하게 된다.
- 데이터가 많아지면 문제가 복잡해 진다. 어떻게 데이터를 적게 가져갈까, 여러 서버로 분산시킬 수 있을까, 필요한 데이터를 최소한의 횟수로 읽어들일 수 있을까 등이 본질적인 과제가 된다.

### 계속 성장하는 서비스와 대규모화의 벽

- 책의 저자가 일한 하테나라는 기업은 처음에 펜티엄 PC 1대로 시작했다.
- 사용자가 늘어나면서 다중화와 부하분산을 적용해 나갔다. 라우터, 아파치의 부하분산, MySQL 레플리케이션 기능을 사용
- 블로그 붐이 발생하면서 시스템이 다운되는 상황이 빈번히 발생
  - 서버 룸에서 인터넷 데이터 센터로 서버 이전
  - 로드밸런서 + 감시 프로그램 도입
  - 병목 지점과 각종 로직이나 DB 스키마를 재검토해서 비효율적인 부문을 서서히 배제
- 그러나 시스템이 안정되었다고 끝내면 결국 그 이후의 성장을 위해서는 동일한 작업이 반복된다.
- 그러지 않기 위해 현재도 개발/인프라 팀이 시스템 품질 개선을 수행

## 2. 대규모 데이터 처리 입문

### 하테나 북마크의 데이터 규모

- 하테나 북마크의 테이블 건수는 3억 5천만 건으로 아래와 같이 데이터를 1건 검색하자
  - `SELECT url FROM entry where eid = 15728423`
- 인덱스를 태우지 않고 1건을 검색하는데 200초가 넘어도 결과가 나오지 않는다.
  - 알겠는가? 200초다 200초. 뭔가 조치를 취해야 한다.

### 대규모 데이터 처리의 어려운 점

#### 메모리 내에서 계산할 수 없다

- 메모리 내에서 계산할 수 없으면 디스크에 있는 데이터를 검색하게 된다.
- 하지만 디스크는 느리므로 I/O 시간이 걸린다.

#### 메모리와 디스크 속도차

- 메모리에서 데이터를 찾는 탐색과 디스크의 원반 내에 있는 데이터를 찾는 것은 얼마의 속도차이가 날까?
  - 10만~100만 배. 이런 수치 감각은 꽤 중요하다.

#### 디스크는 왜 늦을까?

- 메모리는 전기적인 부품이므로 조금 떨어진 데이터를 탐색할 때 마이크로초 단위로 포인터를 이동시킬 수 있다.
- 디스크는 원반이 회전하고 여기서 데이터를 읽어낸다. 즉 메모리와 달리 회전등의 물리적인 동작을 수반하고 있다.
- 이 물리적인 구조가 탐색 속도에 영향을 준다. 따라서 데이터가 메모리에 있다면 물리적인 동작이 없으므로 훨씬 빠르다.
- 메모리와 CPU는 빠른 버스로 연결되어 있어 7.5GB/s 성능이 나오지만 디스크는 58MB/s 로 전송 속도에서 차이가 난다.
- SSD는 물리적인 회전이 아니라 탐색은 빠르지만 버스 속도가 병목이 되거나 그 밖에 구조로 인해 메모리만큼 속도는 나오지 않는다.

### 규모 조정의 요소

#### CPU 부하와 I/O 부하

- 스케일 아웃은 하드웨어를 나열해서 성능을 높여 확장성을 확보하게 된다. 이를 통해 CPU 부하의 확장성을 확보하긴 쉽다.

#### 웹 어플리케이션과 부하의 관계

- 앞 단의 프록시 서버나 로드 밸런서가 요청을 뒷 단에 서버로 전달하고, 서버는 DB에 쿼리를 요청한다.
- 이 과정에서 뒷 단에 서버는 스케일 아웃을 통해 분산을 할 수 있다.

#### DB 확장성 확보의 어려움

- DB는 데이터가 커질수록 메모리에서 처리 못하고 디스크상에서 처리할 수 밖에 없는 요건이 늘어난다.
- 즉 대규모 환경에서는 I/O 부하를 부담하는 DB 서버는 애초에 분산시키기 어렵고 디스크 I/O가 많이 발생하면 금방 느려진다.

### 대규모 데이터를 다루기 위한 기초지식

#### 대규모 데이터를 다루는 세 가지 요령

- 첫 번째 요령은 어떻게 하면 메모리에서 처리를 마칠 수 있을까? 라는 점이다.
  - 디스크 탐색은 확장성, 성능에 크게 영향을 주기 때문이다.
- 두 번째 요령은 데이터량 증가에 강한 알고리즘을 사용하는 것이다.
  - 레코드가 1000만건 있을 때 선형 탐색은 1000만번 수행해야 하지만 Log Order 알고리즘은 수십 번 만에 끝낼 수 있다.
- 데이터 압축이나 검색 기술과 같은 테크닉을 활용할 수 있다.

#### 대규모 데이터를 다루기 전 3대 전제지식

- 프로그램을 만드는 입장에서 알고리즘, 압축, 검색 등이 중요하다.
- 또한 프로그램 개발에 근간이 되는 기초 세 가지를 들겠다.
  - OS 캐시
  - 분산을 고려한 RDBMS 운영
  - 대규모 환경에서 알고리즘과 데이터 구조

