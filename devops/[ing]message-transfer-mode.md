# 메시지 시스템들의 전송 방식

- 메시지 전송 방식의 `적어도 한 번 전송(at-least-once)`, `최대 한 번 전송(at-most-once)`, `중복 없는 전송`, `정확히 한 번 전송`을 알아보자.

## 적어도 한 번 전송

<img src="https://github.com/programmer-sjk/TIL/blob/main/images/devops/at-least-once.png" width="500">

- 위 그림은 적어도 한 번 전송 과정을 그림으로 나타낸 것으로 순서대로 살펴보자
  - 프로듀서가 브로커의 특정 토픽으로 메시지 A를 전송한다.
  - 브로커는 잘 받았다는 의미로 ACK를 프로듀서에게 응답한다.
  - 브로커의 ACK를 받은 프로듀서는 다음 메시지 B를 브로커에게 전송한다.
  - 브로커는 메시지를 받았지만 네트워크 오류나 브로커 장애로 인해 결국 ACK가 프로듀서에게 전달되지 않는다.
  - 메시지 B의 ACK를 받지 못한 프로듀서는 브로커가 메시지 B를 받지 못했다고 판단해 메시지 B를 재전송한다.
- 프로듀서가 메시지 B의 ACK를 받지 못한 시점에, 프로듀서 입장에선 브로커가 데이터를 받고 ACK를 전송하지 못한건지 데이터를 받지 못해서 ACK를 전송하지 못한건지 알 수가 없다. 이때 적어도 한 번 전송 방식에 따라 메시지 B를 다시 전송한다. 만약 브로커가 데이터를 받지 못했다면 처음 메시지를 저장하고, 브로커가 데이터를 받은 상태라면 중복 저장이 된다.
- 이렇게 일부 메시지 중복이 발생하더라도 최소한 하나의 메시지는 반드시 보장한다는 것이 적어도 한 번 전송 방식이며 카프카는 기본적으로 이 방식으로 동작한다.

## 최대 한 번 전송

<img src="https://github.com/programmer-sjk/TIL/blob/main/images/devops/at-most-once.png" width="500">

- 위 그림은 최대 한 번 전송 과정을 그림으로 나타낸 것으로 순서대로 살펴보자
  - 프로듀서가 브로커의 특정 토픽으로 메시지 A를 전송한다.
  - 브로커는 잘 받았다는 의미로 ACK를 프로듀서에게 응답한다.
  - 브로커의 ACK를 받은 프로듀서는 다음 메시지 B를 브로커에게 전송한다.
  - 브로커는 메시지를 받았지만 네트워크 오류나 브로커 장애로 인해 결국 ACK가 프로듀서에게 전달되지 않는다.
  - 프로듀서는 브로커가 받았다고 가정하고 메시지 C를 전송한다.
- 최대 한 번 전송은 ACK를 받지 못해도 재전송하지 않는다. 위 그림에서 사실 ACK를 받는 부분은 의미가 없지만 적어도 한 번 전송과 비교하기 위해 넣어두었다. 정리하면 최대 한 번 전송은 메시지 손실을 감안하더라도 중복 전송은 하지 않는 경우이다.
- 일부 메시지가 손실되더라도 높은 처리량을 필요로 하는 대량의 로그 수집이나 IoT 같은 환경에서 사용된다.

## 중복 없는 전송

- 카프카의 0.11 버전부터 프로듀서가 메시지를 중복 없이 브로커로 전송할 수 있는 기능이 추가되었다.

<img src="https://github.com/programmer-sjk/TIL/blob/main/images/devops/no-duplicate.png" width="500">

-
