# 메시지 큐

- FIFO 자료구조의 큐로써 아키텍처 관점에선 Producer / Consumer 구조로 메시지를 저장한다.
- 대표적으로 **`Kafka, SQS, RabbitMQ`** 등의 메시지 큐가 활용되고 있다.

## 메시지 큐를 사용했을 때 장점

- **`비동기 처리를`** 통해 빠른 응답을 가능케 하고 추가적인 후처리는 뒷단에서 진행한다.
- **`두 서비스간 결합도를 낮춘다`**. 두 서비스는 서로를 알 필요가 없고 오직 Producer / Consumer의 역할로 메시지 큐에 메시지를 전달하고 받는다.
- Consumer 서비스에 장애가 발생했을 때 일정기간 메시지를 보관하여 Consumer가 재 시작시 해당 메시지를 처리할 수 있다.
- Producer / Consumer 를 추가해서 트래픽이 몰릴 때 확장하기 쉽다.

## 메시지 큐를 사용했을 때 단점

- 비용이 든다.
- 메시지의 순서 보장 / 메세지 처리 실패 후 재시도 / 메시지 중복 등의 처리에 대해 파악해야 함
- 기능이 실패했을 때 실패 지점을 찾는데 시간이 더 소요된다.

## 메시지 큐를 사용할 때 주의해야 할 점

- 메시지의 순서 보장
- 메시지 수신 후 실패
- 메시지 중복

## AWS SQS

- AWS가 제공하는 메시지 큐로 `standard`와 `fifo` 형태의 큐를 제공한다.
- fifo Queue를 사용하지 않는다면 메시지가 중복으로 들어올 수 있기 때문에 컨슈머에서 멱등성있게 처리해야 한다.

## 만약 consumer가 죽으면 어떻게 동작하는가?

- SQS에 메시지가 들어가고 consumer가 죽으면 어떻게 될까
- SQS는 retention period(최대 14일) 기간 동안 메시지를 삭제하지 않고 보존한다.
- 따라서 consumer 서비스가 살아서 SQS에 붙게 되면 메시지를 수신할 수 있다.

## FIFO Queue

- SQS의 FIFO Queue는 **`정확한 순서 전달과 정확히 한 번 전송을 제공한다`**.
- 순서가 중요한 전자상거래나 티켓팅 시스템에 활용될 수 있다.
- 300 TPS의 메시지 처리량을 지원하며 비용은 standard에 비해 조금 더 비싸다.

  <img src="https://github.com/programmer-sjk/TIL/blob/main/images/message-queue/sqs-fifo-vs-standard.png" width="400">

## Kafka

### kafka 에서 순서 보장

- 카프카에서는 **`하나의 파티션에 대해서는 메시지 순서를 보장할 수 있다`**.
- 하지만 토픽에 파티션이 하나 뿐이라면 카프카 성능의 이점을 볼 수 없기 때문에 보통 토픽에는 여러 파티션이 존재한다.
- 여러 파티션이 존재할 때 **`키를 지정할 경우 동일한 파티션에 메시지가 적재되어`** 메시지의 순서를 보장할 수 있다.

### 메시지 수신 후 실패

- 메시지 수신 후 어플리케이션 로직이 실패하면 카프카 파티션의 offset이 commit 되지 않는다.
- 메시지가 다시 컨슘되기 때문에 비지니스 로직을 멱등성 처리해야 한다.

### 메시지 중복

- 카프카도 **`적어도 한 번 전송(At least once)을 지원하고`** 있기 때문에 중복되어 들어올 수 있다.
- 이에 따라 컨슈머 로직에는 멱등성 처리가 필요하다.
