# MySQL Lock

- DB에서 Lock은 동시성을 제어하기 위해 사용한다.
- 다수의 트랜잭션에서 동시에 데이터를 조회, 수정하기 위해 접근할 때 락을 획득한 커넥션이 작업이 우선 처리된다.

## 비관적 락 vs 낙관적 락

- 락의 종류는 크게 비관적 락과 낙관적 락으로 나뉜다.
- 동시성을 비관적으로 보고 실제로 락을 잡는 비관적 락과, 낙관적으로 보고 락을 사용하지 않는 낙관적 락이다.
- 비관적 락은 실제로 공유 락이나 배타 락을 잡아서 동시성을 제어하는 방법이다. 두 락에 대해서는 아래에서 더 알아본다.
- 낙관적 락은 작업을 수행하고 충돌이 발생했다면 후에 실행된 쿼리를 실패시키는 방법이다.
- 주로 version 컬럼을 하나 추가하고 작업을 수행 후, version 값을 검사하는 방식을 많이 사용한다.

  <img src="https://github.com/programmer-sjk/TIL/blob/main/images/db/optimistic-lock.png" width="400">

- 위 그림을 살펴보자.
  - 사용자 A, B가 동시에 트랜잭션을 시작하고 이때 버전 값은 1이다.
  - A의 작업이 먼저 commit 되어 2로 수정되면 A의 경우 버전 값이 정상적으로 1 증가했기에 정상 종료된다.
  - B의 작업이 이후 실행되며 처음 읽은 version 값 1이 수정되었기 때문에 실패한다.
- 경쟁이 치열한 환경에서 낙관적 락은 vesrion 값 체크와 rollback 작업이 빈번해 질 수 있어 성능이 좋지 않다.
- 따라서 동시성이 높다면 비관적 락을, 동시성이 낮다고 판단하면 낙관적 락을 고려해볼 수 있다.

## 공유 락 vs 배타 락

## AUTO INCREMENT 락

## InnoDB 락

- 레코드 락
- 갭락
- 넥스트 키 락
