# Table Cache

- MySQL에서 모든 CRUD 쿼리는 **테이블을 열고 닫는 과정**을 반복한다.
- 위 작업은 약간의 부하가 있기에 테이블의 메타정보를 `Table Cache`에 담아두고 커넥션마다 공유해서 사용하게 된다.
  - 추가적인 메모리는 사용되지만 성능은 일반적으로 향상됨
- 만약 테이블의 개수가 많아지고 트래픽이 높을 때 Table Cache로 인한 성능 저하가 발생 가능
  - 테이블이 수십개고, 커넥션이 2~300개 정도면 문제될게 없음
  - 테이블이 수백, 수천개고 커넥션이 높다면 메모리 부족현상이 발생 가능

## 언제/어떻게 Table Cache에서 제거될까

### Table Cache에서 제거되는 경우

- 캐시가 가득 찬 상태에서, 스레드가 캐시에 없는 테이블을 열려고 시도하는 경우.
- 캐시가 `table_open_cache` 값 보다 많이 포함하고, 특정 테이블들이 어떤 스레드에서도 사용되지 않을 때
- 테이블 flush 작업이 발생한 경우 (FLUSH TABLES 명령이 실행될 때)

### 어떻게 제거되나?

- 테이블 캐시가 가득차면 서버는 아래 절차로 삭제할 캐시를 찾는다.
  - 가장 최근에 사용되지 않은 테이블부터 시작하여 현재 사용하지 않는 테이블이 해제된다.
  - 캐시가 가득 찼는데, 모든 테이블이 사용중이라면 캐시를 임시로 확장한다. 그 후 테이블이 사용되지 않는다면 테이블이 닫히고 캐시에서 제거된다.

## 관련 시스템 정보

- table_open_cache
  - 테이블 캐시에 저장될 수 있는 테이블 수
  - 명령어: `select @@table_open_cache;`
- open_tables
  - MySQL 서버가 시작 후에 table-opening 연산이 발생한 횟수
  - 명령어: `SHOW GLOBAL STATUS LIKE 'Opened_tables'`

## 언제 설정을 수정 할까?

- 깊게 파보면 `cache hit, uptime, max_connections` 등등을 고려해서 정해야 하는데, 이 지식을 평생 안 쓸수도 있기에 큰 맥락에서 2가지로 정힌다.
  - 테이블 개수도 많고(table_open_cache보다 테이블이 많을 경우), 심지어 테이블 마다 파티션수도 많아서 테이블 캐시로 인한 부하가 예상될 때
  - **`Opened_tables`** 시스템 변수를 확인했을 때 값이 매우 높거나 빠르게 증가할 때
