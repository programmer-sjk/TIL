# MSA 환경에서 분산 트랜잭션

- MSA 환경에선 여러 DB로 서비스가 구성되기에 트랜잭션 처리가 힘들다는 단점이 있다.
- MSA 환경에서 분산 트랜잭션을 위한 방법들을 정리한다.

## 2 Phase Commit Pattern (2PC 패턴)

- 중간에 코디네이터(트랜잭션 관리자)를 두는 방식. prepare, commit 2 단계로 나뉜다.
- 주문 DB와 재고 DB가 나뉘어있다고 가정하자.
  - prepare 단계: 주문 요청을 받은 코디네이터는 주문 서비스와 재고 서비스에 각각 쿼리를 처리할 수 있는지 요청한다. 주문은 사용자의 쿠폰이나 포인트 등 주문을 진행할 수 있는지 유효성을 확인하고 문제가 없다면 가능하다고 응답한다. 재고 서비스도 재고에 문제가 없으면 가능하다고 응답한다.
  - commit 단계: 코디네이터는 분산된 서비스로부터 모두 가능하다는 응답을 받으면 commit 요청을 전달하고 각각의 서비스가 commit 하는 구조이다.
- 분산 DB에서 트랜잭션이 가능하지만 아래와 같은 단점들이 있다.
  - 코디네이터가 SPOF가 될 수 있다.
  - 코디네이터와 각 서비스간 결합도가 강해진다.
  - 각 DB는 특정 레코드를 조회하거나 업데이트시 레코드에 락을 걸기 때문에 응답시간이 지연된다.
- 결론적으로 2PC 패턴은 이론적인 방법이나 실무에서는 성능 이슈가 커 잘 사용하지 않는다.
